name: Build Windows DLLs

on:
  push:
    branches: [master]
    tags: ['v*']
  pull_request:
    branches: [master]

jobs:
  build:
    runs-on: windows-latest
    strategy:
      matrix:
        include:
          - arch: x64
            msvc_arch: amd64
            sizeof_size_t: 8
          - arch: x86
            msvc_arch: x86
            sizeof_size_t: 4

    steps:
      - uses: actions/checkout@v4

      - name: Setup MSVC
        uses: ilammy/msvc-dev-cmd@v1
        with:
          arch: ${{ matrix.msvc_arch }}

      - name: Generate prototab
        run: |
          New-Item -ItemType Directory -Force -Path build\src | Out-Null
          perl src/mkprototab.pl build/src/prototab.c build/src/prototab.h

      - name: Generate config headers
        shell: pwsh
        run: |
          @"
          /* config.h - Generated by GitHub Actions for Windows ${{ matrix.arch }} */

          #define HAVE_FCNTL_H 1
          #define HAVE_FSEEKI64 1
          #define HAVE_INTTYPES_H 1
          #define HAVE_MALLOC_H 1
          #define HAVE_MEMMOVE 1
          #define HAVE_MEMORY_H 1
          #define HAVE_MEMSET 1
          #define HAVE_STDINT_H 1
          #define HAVE_STDLIB_H 1
          #define HAVE_STRCHR 1
          #define HAVE_STRERROR 1
          #define HAVE_STRING_H 1
          #define HAVE_SYS_STAT_H 1
          #define HAVE_SYS_TYPES_H 1
          #define STDC_HEADERS 1

          #define SIZEOF_LONG 4
          #define SIZEOF_LONG_LONG 8
          #define SIZEOF_SIZE_T ${{ matrix.sizeof_size_t }}
          #define SIZEOF_UNSIGNED_INT 4
          #define SIZEOF_UNSIGNED_LONG 4
          #define SIZEOF_UNSIGNED_SHORT 2

          #define PACKAGE "librsync"
          #define VERSION "2.0.1"
          "@ | Set-Content -Path build/src/config.h -Encoding ASCII

          @"
          #ifndef _LIBRSYNC_CONFIG_H
          #define _LIBRSYNC_CONFIG_H
          typedef __int64    rs_long_t;
          #endif /* _LIBRSYNC_CONFIG_H */
          "@ | Set-Content -Path build/src/librsync-config.h -Encoding ASCII

      - name: Compile
        run: |
          cl.exe /nologo /O2 /DWIN32 /D_WIN32 /D_WINDOWS /DNDEBUG /I"src" /I"build/src" /c `
            src/base64.c src/buf.c src/checksum.c src/command.c src/delta.c `
            src/emit.c src/fileutil.c src/hex.c src/isprefix.c src/job.c `
            src/mdfour.c src/mksum.c src/msg.c src/netint.c src/patch.c `
            build/src/prototab.c src/readsums.c src/rollsum.c src/scoop.c `
            src/search.c src/stats.c src/stream.c src/sumset.c src/trace.c `
            src/tube.c src/util.c src/version.c src/whole.c src/blake2b-ref.c

      - name: Link
        run: |
          link.exe /nologo /DLL /OUT:rsync_win_${{ matrix.arch }}.dll `
            base64.obj buf.obj checksum.obj command.obj delta.obj `
            emit.obj fileutil.obj hex.obj isprefix.obj job.obj `
            mdfour.obj mksum.obj msg.obj netint.obj patch.obj `
            prototab.obj readsums.obj rollsum.obj scoop.obj `
            search.obj stats.obj stream.obj sumset.obj trace.obj `
            tube.obj util.obj version.obj whole.obj blake2b-ref.obj `
            advapi32.lib

      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: rsync_win_${{ matrix.arch }}
          path: rsync_win_${{ matrix.arch }}.dll

  release:
    needs: build
    if: startsWith(github.ref, 'refs/tags/v')
    runs-on: ubuntu-latest
    permissions:
      contents: write

    steps:
      - name: Download x64 artifact
        uses: actions/download-artifact@v4
        with:
          name: rsync_win_x64

      - name: Download x86 artifact
        uses: actions/download-artifact@v4
        with:
          name: rsync_win_x86

      - name: Create release
        uses: softprops/action-gh-release@v2
        with:
          files: |
            rsync_win_x64.dll
            rsync_win_x86.dll
