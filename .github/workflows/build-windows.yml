name: Build Windows DLLs

on:
  push:
    branches: [master]
    tags: ['v*']
  pull_request:
    branches: [master]

jobs:
  build:
    runs-on: windows-latest
    strategy:
      matrix:
        include:
          - arch: x64
            msvc_arch: amd64
            sizeof_size_t: 8
          - arch: x86
            msvc_arch: x86
            sizeof_size_t: 4

    steps:
      - uses: actions/checkout@v4

      - name: Setup MSVC
        uses: ilammy/msvc-dev-cmd@v1
        with:
          arch: ${{ matrix.msvc_arch }}

      - name: Generate config headers
        shell: pwsh
        run: |
          New-Item -ItemType Directory -Force -Path build/src | Out-Null

          @"
          /* config.h - Generated by GitHub Actions for Windows ${{ matrix.arch }} */

          #define HAVE_SYS_STAT_H 1
          #define HAVE_SYS_TYPES_H 1
          #define HAVE_IO_H 1
          #define HAVE_FCNTL_H 1
          #define HAVE__FSEEKI64 1
          #define HAVE__FSTATI64 1
          #define HAVE__FILENO 1
          #define STDC_HEADERS 1

          #define SIZEOF_LONG 4
          #define SIZEOF_LONG_LONG 8
          #define SIZEOF_SIZE_T ${{ matrix.sizeof_size_t }}
          #define SIZEOF_UNSIGNED_INT 4
          #define SIZEOF_UNSIGNED_LONG 4
          #define SIZEOF_UNSIGNED_SHORT 2

          #define PACKAGE "librsync"
          #define VERSION "2.3.4"
          "@ | Set-Content -Path build/src/config.h -Encoding ASCII

      - name: Compile
        run: |
          cl.exe /nologo /O2 /std:c11 /DWIN32 /D_WIN32 /D_WINDOWS /DNDEBUG `
            /D_CRT_SECURE_NO_WARNINGS /Drsync_EXPORTS `
            /I"src" /I"src/blake2" /I"build/src" /c `
            src/prototab.c src/base64.c src/buf.c src/checksum.c src/command.c `
            src/delta.c src/emit.c src/fileutil.c src/hashtable.c src/hex.c `
            src/job.c src/mdfour.c src/mksum.c src/msg.c src/netint.c `
            src/patch.c src/rabinkarp.c src/readsums.c src/rollsum.c src/scoop.c `
            src/stats.c src/sumset.c src/trace.c src/tube.c src/util.c `
            src/version.c src/whole.c src/blake2/blake2b-ref.c

      - name: Link
        run: |
          link.exe /nologo /DLL /OUT:rsync_win_${{ matrix.arch }}.dll `
            prototab.obj base64.obj buf.obj checksum.obj command.obj `
            delta.obj emit.obj fileutil.obj hashtable.obj hex.obj `
            job.obj mdfour.obj mksum.obj msg.obj netint.obj `
            patch.obj rabinkarp.obj readsums.obj rollsum.obj scoop.obj `
            stats.obj sumset.obj trace.obj tube.obj util.obj `
            version.obj whole.obj blake2b-ref.obj `
            advapi32.lib

      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: rsync_win_${{ matrix.arch }}
          path: rsync_win_${{ matrix.arch }}.dll

  release:
    needs: build
    if: startsWith(github.ref, 'refs/tags/v')
    runs-on: ubuntu-latest
    permissions:
      contents: write

    steps:
      - name: Download x64 artifact
        uses: actions/download-artifact@v4
        with:
          name: rsync_win_x64

      - name: Download x86 artifact
        uses: actions/download-artifact@v4
        with:
          name: rsync_win_x86

      - name: Create release
        uses: softprops/action-gh-release@v2
        with:
          files: |
            rsync_win_x64.dll
            rsync_win_x86.dll
